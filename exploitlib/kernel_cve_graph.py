import requests
import re
import pandas as pd
import matplotlib.pyplot as plt
from collections import Counter

def download_cve_data():
    url = 'https://raw.githubusercontent.com/nluedtke/linux_kernel_cves/master/data/CVEs.txt'
    response = requests.get(url)
    if response.status_code == 200:
        return response.text
    else:
        raise Exception("Failed to download CVE data")

def parse_cve_data(cve_data):
    cve_entries = {}
    version_count = Counter()
    for line in cve_data.splitlines():
        if line.strip():
            match = re.match(r'(CVE-\d{4}-\d+): [^ ]+ - [^ ]+ \((.*?)\)', line.strip())
            if match:
                versions = match.group(2)
                version_pattern = re.compile(r'v(\d+\.\d+)')
                matches = version_pattern.findall(versions)
                version_count.update(matches)
    return version_count

def plot_cve_data(version_count):
    versions = list(version_count.keys())
    counts = [version_count[v] for v in versions]
    versions, counts = zip(*sorted(zip(versions, counts), key=lambda x: x[0]))  # Sort by version
    plt.figure(figsize=(10, 5))
    plt.bar(versions, counts, color='blue')
    plt.xlabel('Kernel Version')
    plt.ylabel('Number of CVEs')
    plt.title('Number of CVEs per Linux Kernel Version')
    plt.xticks(rotation=90)  # Rotate version labels for better readability
    plt.tight_layout()
    plt.show()

def main():
    cve_data = download_cve_data()
    version_count = parse_cve_data(cve_data)
    plot_cve_data(version_count)

if __name__ == "__main__":
    main()
