#include <linux/module.h>
#include <linux/uaccess.h>

#include "arbrw.h"

MODULE_LICENSE("GPL");
MODULE_AUTHOR("fist");

int init_arbrw(void) {
	//using the user struct exclusively to read/write a uint64 without allocating/freeing kernel memory
	return 0;
}
 
long arbrw_ioctl(struct file *file, unsigned int cmd, unsigned long arg) {
	struct arbrw user;
	int r;

	//get user struct from user
	r = copy_from_user((void *)&user, (const void *)arg, sizeof(user));
	if (r) {
		return r;
	}

	//perform the arbitrary read or write and return ERROR on failure, 0 on 0	
	if (cmd == ARBREAD) {
		r = copy_to_user(user.userptr, user.kptr, sizeof(unsigned long));
		if (r) {
			return r;
		}
	}
	else if (cmd == ARBWRITE) {
		r = copy_from_user(user.kptr, user.userptr, sizeof(unsigned long));
		if (r) {
			return r;
		}
	}
	
	return 0;
}

void cleanup_arbrw(void) {
	//no memory is allocated for this vuln
}
